{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/work/v0-domain-expiry-checker/app/api/check-links/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\nimport { JSDOM } from \"jsdom\"\r\n\r\nexport const maxDuration = 60\r\n\r\ninterface LinkCheckResult {\r\n  url: string\r\n  status: number | null\r\n  statusText: string\r\n  isBroken: boolean\r\n  errorType: string\r\n  foundOn: string\r\n}\r\n\r\ninterface PageData {\r\n  url: string\r\n  links: string[]\r\n}\r\n\r\nasync function fetchSitemap(baseUrl: string): Promise<string[]> {\r\n  try {\r\n    const sitemapUrl = new URL(\"/sitemap.xml\", baseUrl).href\r\n    const res = await fetch(sitemapUrl, { signal: AbortSignal.timeout(4000) })\r\n    if (!res.ok) return []\r\n    const text = await res.text()\r\n    const regex = /<loc>(.*?)<\\/loc>/g\r\n    const urls: string[] = []\r\n    let match\r\n    while ((match = regex.exec(text)) !== null) {\r\n      const foundUrl = match[1].trim()\r\n      if (!foundUrl.endsWith(\".xml\") && !foundUrl.includes(\"/wp-admin/\") && !foundUrl.includes(\"/login\")) {\r\n        urls.push(foundUrl)\r\n      }\r\n    }\r\n    return urls\r\n  } catch {\r\n    return []\r\n  }\r\n}\r\n\r\nasync function getLinksFromPage(url: string, baseOrigin: string): Promise<PageData> {\r\n  try {\r\n    const res = await fetch(url, {\r\n      headers: {\r\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\r\n      },\r\n      signal: AbortSignal.timeout(8000)\r\n    })\r\n\r\n    if (!res.ok) return { url, links: [] }\r\n    const text = await res.text()\r\n    const dom = new JSDOM(text, { url })\r\n    const document = dom.window.document\r\n    const anchors = Array.from(document.querySelectorAll(\"a\"))\r\n\r\n    const links = anchors\r\n      .map(a => a.href)\r\n      .filter(href => {\r\n        if (!href || href === \"#\") return false\r\n        if (href.startsWith(\"javascript:\") || href.startsWith(\"mailto:\") || href.startsWith(\"tel:\")) return false\r\n        const lower = href.toLowerCase()\r\n        if (lower.includes(\"/login\") || lower.includes(\"/admin\") || lower.includes(\"/wp-login\") || lower.includes(\"/wp-admin\")) return false\r\n        return true\r\n      })\r\n      .map(href => {\r\n        try {\r\n          // Flatten URLs by removing fragments\r\n          const urlObj = new URL(href, url)\r\n          urlObj.hash = \"\"\r\n          return urlObj.href\r\n        } catch {\r\n          return \"\"\r\n        }\r\n      })\r\n      .filter(h => h !== \"\")\r\n\r\n    return { url, links: Array.from(new Set(links)) }\r\n  } catch {\r\n    return { url, links: [] }\r\n  }\r\n}\r\n\r\nasync function validateLink(url: string, foundOn: string): Promise<LinkCheckResult> {\r\n  try {\r\n    const res = await fetch(url, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"User-Agent\": \"Mozilla/5.0 (compatible; BrokenLinkChecker/3.0; +https://jr-tools.com)\",\r\n      },\r\n      signal: AbortSignal.timeout(10000),\r\n      redirect: \"follow\"\r\n    })\r\n\r\n    const status = res.status\r\n    let isBroken = false\r\n    let errorType = \"Clean\"\r\n\r\n    if (status === 404) {\r\n      isBroken = true\r\n      errorType = \"404 Not Found\"\r\n    } else if (status === 410) {\r\n      isBroken = true\r\n      errorType = \"410 Gone\"\r\n    } else if (status >= 500) {\r\n      isBroken = true\r\n      errorType = `${status} Server Error`\r\n    } else if (status >= 200 && status < 400) {\r\n      isBroken = false\r\n      errorType = \"Clean\"\r\n    } else {\r\n      isBroken = false\r\n      errorType = \"Security/Blocked\"\r\n    }\r\n\r\n    return {\r\n      url,\r\n      status,\r\n      statusText: res.statusText || `HTTP ${status}`,\r\n      isBroken,\r\n      errorType,\r\n      foundOn\r\n    }\r\n  } catch (error: any) {\r\n    const errorMsg = error?.message?.toLowerCase() || \"\"\r\n    let errorType = \"Network Error\"\r\n    let isBroken = true\r\n\r\n    if (error.name === \"AbortError\" || errorMsg.includes(\"timeout\")) {\r\n      errorType = \"Timeout\"\r\n    } else if (errorMsg.includes(\"enotfound\") || errorMsg.includes(\"dns\")) {\r\n      errorType = \"DNS Error\"\r\n    } else if (errorMsg.includes(\"cert\") || errorMsg.includes(\"ssl\") || errorMsg.includes(\"tls\")) {\r\n      errorType = \"SSL Error\"\r\n    } else {\r\n      isBroken = false\r\n    }\r\n\r\n    return {\r\n      url,\r\n      status: 0,\r\n      statusText: \"Failed\",\r\n      isBroken,\r\n      errorType,\r\n      foundOn\r\n    }\r\n  }\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { url } = await req.json()\r\n    if (!url) return NextResponse.json({ error: \"URL is required\" }, { status: 400 })\r\n\r\n    let targetUrl = url.trim()\r\n    if (!targetUrl.startsWith(\"http\")) targetUrl = `https://${targetUrl}`\r\n\r\n    const baseOrigin = new URL(targetUrl).origin\r\n\r\n    // 1. IMPROVED PAGE DISCOVERY\r\n    let discoveredPages = new Set<string>([targetUrl])\r\n\r\n    // Try Sitemap first\r\n    const sitemapPages = await fetchSitemap(targetUrl)\r\n    sitemapPages.forEach(p => discoveredPages.add(p))\r\n\r\n    // If sitemap is sparse, crawl home + 1 level\r\n    if (discoveredPages.size < 5) {\r\n      const homeData = await getLinksFromPage(targetUrl, baseOrigin)\r\n      homeData.links.forEach(l => {\r\n        if (l.startsWith(baseOrigin)) discoveredPages.add(l)\r\n      })\r\n    }\r\n\r\n    // Limit crawl to 40 pages to stay within 60s timeout\r\n    const pagesToCrawl = Array.from(discoveredPages).slice(0, 40)\r\n\r\n    // 2. Multiphase extraction\r\n    const pageResults = await Promise.all(pagesToCrawl.map(p => getLinksFromPage(p, baseOrigin)))\r\n    const linkToPageMap = new Map<string, string>()\r\n    pageResults.forEach(p => {\r\n      p.links.forEach(l => {\r\n        if (!linkToPageMap.has(l)) linkToPageMap.set(l, p.url)\r\n      })\r\n    })\r\n\r\n    const uniqueLinks = Array.from(linkToPageMap.keys()).slice(0, 200)\r\n\r\n    // 3. Batch Validation\r\n    const results: LinkCheckResult[] = []\r\n    const BATCH_SIZE = 25\r\n    for (let i = 0; i < uniqueLinks.length; i += BATCH_SIZE) {\r\n      const batch = uniqueLinks.slice(i, i + BATCH_SIZE)\r\n      const batchResults = await Promise.all(\r\n        batch.map(l => validateLink(l, linkToPageMap.get(l)!))\r\n      )\r\n      results.push(...batchResults.filter(r => r.isBroken))\r\n    }\r\n\r\n    return NextResponse.json({\r\n      totalPagesCrawled: pagesToCrawl.length,\r\n      totalLinksChecked: uniqueLinks.length,\r\n      results\r\n    })\r\n\r\n  } catch (error: any) {\r\n    return NextResponse.json({ error: error.message }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}