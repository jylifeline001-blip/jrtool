{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/work/v0-domain-expiry-checker/app/api/whois/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { domain } = await req.json()\r\n\r\n    if (!domain || typeof domain !== \"string\") {\r\n      return NextResponse.json({ error: \"Domain is required\" }, { status: 400 })\r\n    }\r\n\r\n    const cleanDomain = domain\r\n      .replace(/https?:\\/\\//g, \"\")\r\n      .replace(/^www\\./, \"\")\r\n      .split(\"/\")[0]\r\n      .toLowerCase()\r\n      .trim()\r\n\r\n    if (\r\n      !cleanDomain ||\r\n      !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?(\\.[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/.test(cleanDomain)\r\n    ) {\r\n      return NextResponse.json({ error: \"Invalid domain format\" }, { status: 400 })\r\n    }\r\n\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), 10000)\r\n\r\n    console.log(\"[v0] Fetching RDAP data for:\", cleanDomain)\r\n\r\n    // Try RDAP first (more reliable than WHOIS)\r\n    const rdapUrl = `https://rdap.org/domain/${cleanDomain}`\r\n    const response = await fetch(rdapUrl, {\r\n      method: \"GET\",\r\n      signal: controller.signal,\r\n      headers: {\r\n        Accept: \"application/rdap+json\",\r\n      },\r\n    }).catch(() => null)\r\n\r\n    clearTimeout(timeoutId)\r\n\r\n    if (!response || !response.ok) {\r\n      console.log(\"[v0] RDAP lookup failed, trying whois.vu service\")\r\n\r\n      // Fallback to whois.vu\r\n      const whoisController = new AbortController()\r\n      const whoisTimeoutId = setTimeout(() => whoisController.abort(), 10000)\r\n\r\n      const whoisResponse = await fetch(`https://www.whois.vu/?domain=${encodeURIComponent(cleanDomain)}`, {\r\n        signal: whoisController.signal,\r\n      })\r\n\r\n      clearTimeout(whoisTimeoutId)\r\n\r\n      if (!whoisResponse.ok) {\r\n        throw new Error(\"Unable to fetch WHOIS data from any service\")\r\n      }\r\n\r\n      // Parse HTML response from whois.vu\r\n      const html = await whoisResponse.text()\r\n      const data = parseWhoisHTML(html, cleanDomain)\r\n\r\n      return NextResponse.json(data)\r\n    }\r\n\r\n    const data = await response.json()\r\n    console.log(\"[v0] RDAP response received\")\r\n\r\n    // Parse RDAP response\r\n    const parsedData = parseRDAPResponse(data, cleanDomain)\r\n    return NextResponse.json(parsedData)\r\n  } catch (error) {\r\n    console.error(\"[v0] WHOIS lookup error:\", error)\r\n\r\n    if (error instanceof Error) {\r\n      if (error.name === \"AbortError\") {\r\n        return NextResponse.json({ error: \"Request timeout. Please try again.\" }, { status: 504 })\r\n      }\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { error: \"Unable to fetch domain information. The domain may not exist or be restricted.\" },\r\n      { status: 500 },\r\n    )\r\n  }\r\n}\r\n\r\nfunction parseRDAPResponse(data: any, domain: string) {\r\n  let expiryDate = null\r\n  let creationDate = null\r\n  let updatedDate = null\r\n  let registrar = null\r\n  const status: string[] = []\r\n\r\n  // Extract dates from RDAP events\r\n  if (data.events && Array.isArray(data.events)) {\r\n    for (const event of data.events) {\r\n      if (event.eventAction === \"expiration\") {\r\n        expiryDate = event.eventDate\r\n      } else if (event.eventAction === \"registration\") {\r\n        creationDate = event.eventDate\r\n      } else if (event.eventAction === \"last changed\") {\r\n        updatedDate = event.eventDate\r\n      }\r\n    }\r\n  }\r\n\r\n  // Extract registrar from entities\r\n  if (data.entities && Array.isArray(data.entities)) {\r\n    for (const entity of data.entities) {\r\n      if (entity.roles && entity.roles.includes(\"registrar\") && entity.vcardArray) {\r\n        registrar = extractVCardName(entity.vcardArray)\r\n        break\r\n      }\r\n    }\r\n  }\r\n\r\n  // Extract status\r\n  if (data.status && Array.isArray(data.status)) {\r\n    status.push(...data.status)\r\n  }\r\n\r\n  return {\r\n    domain,\r\n    expiryDate,\r\n    creationDate,\r\n    updatedDate,\r\n    registrar,\r\n    status,\r\n  }\r\n}\r\n\r\nfunction parseWhoisHTML(html: string, domain: string) {\r\n  const result = {\r\n    domain,\r\n    expiryDate: null as string | null,\r\n    creationDate: null as string | null,\r\n    updatedDate: null as string | null,\r\n    registrar: null as string | null,\r\n    status: [] as string[],\r\n  }\r\n\r\n  // Simple regex patterns to extract data\r\n  const expiryMatch = html.match(/Expir[a-z]*\\s*(?:Date)?[:\\s]*([^<\\n]+)/i)\r\n  if (expiryMatch) {\r\n    result.expiryDate = expiryMatch[1].trim()\r\n  }\r\n\r\n  const createdMatch = html.match(/Creat[a-z]*\\s*(?:Date)?[:\\s]*([^<\\n]+)/i)\r\n  if (createdMatch) {\r\n    result.creationDate = createdMatch[1].trim()\r\n  }\r\n\r\n  const updatedMatch = html.match(/(?:Last\\s+)?Updat[a-z]*\\s*(?:Date)?[:\\s]*([^<\\n]+)/i)\r\n  if (updatedMatch) {\r\n    result.updatedDate = updatedMatch[1].trim()\r\n  }\r\n\r\n  const registrarMatch = html.match(/Registrar[:\\s]*([^<\\n]+)/i)\r\n  if (registrarMatch) {\r\n    result.registrar = registrarMatch[1].trim()\r\n  }\r\n\r\n  const statusMatch = html.match(/Status[:\\s]*([^<\\n]+)/i)\r\n  if (statusMatch) {\r\n    const statusStr = statusMatch[1].trim()\r\n    result.status = statusStr.split(/[,;]/).map((s) => s.trim())\r\n  }\r\n\r\n  return result\r\n}\r\n\r\n// Helper to extract name from vCard\r\nfunction extractVCardName(vcard: any[]): string | null {\r\n  for (const prop of vcard) {\r\n    if (prop[0] === \"fn\") {\r\n      return prop[3]\r\n    }\r\n  }\r\n  return null\r\n}\r\n"],"names":[],"mappings":"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"}}]
}